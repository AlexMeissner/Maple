@page "/logs"

@using DataTransfer
@using Maple.Services
@using System.Globalization

@inject IJSRuntime JSRuntime
@inject ILogEntryRepository LogEntryRepository

@implements IDisposable

<PageTitle>Logs</PageTitle>

<div>
    <div class="input-group mb-3">
        <select class="form-select" @onchange="OnProjectChanged">
            @foreach (var project in _projects)
            {
                <option value="@project.Guid">@project.Name</option>
            }
        </select>
        <input class="form-control filter" type="text" placeholder="Filter..." @oninput="OnFilterChanged" />
    </div>
    <div class="content">
        <div class="properties">
            <table class="table ">
                <thead>
                    <tr>
                        <th></th>
                        <th>Property</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="sortable-table">
                    @foreach (var logProperties in _logProperties)
                    {
                        <tr>
                            <td>
                                <span class="bi bi-grip-vertical" aria-hidden="true"></span>
                            </td>
                            <td>
                                <span>@logProperties.Name</span>
                            </td>
                            <td>
                                <input type="checkbox" @bind="logProperties.IsActive" @bind:after="OnPropertyChanged" />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="log-entires">
            <table class="table">
                <thead>
                    <tr>
                        @foreach (var propertyName in ActiveProperties)
                        {
                            <th>@propertyName</th>
                        }
                    </tr>
                </thead>
                <tbody id="sortable-table">
                    @foreach (var logEntry in _logEntries)
                    {
                        <tr>
                            @foreach (var propertyName in ActiveProperties)
                            {
                                <td>@GetValue(logEntry, propertyName)</td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    internal class LogProperties
    {
        public required string Name { get; set; }
        public bool IsActive { get; set; }
    }

    internal class Project
    {
        public Guid? Guid { get; set; }
        public required string Name { get; set; }
    }

    private DotNetObjectReference<Logs>? _selfReference;

    private Guid? _selectedProject;
    private string? _filter;

    private List<Project> _projects = [];
    private List<LogEntryDto> _logEntries = [];
    private List<LogProperties> _logProperties = [];

    private IEnumerable<string> ActiveProperties => _logProperties.Where(p => p.IsActive).Select(p => p.Name);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _selfReference = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("initializeSortable", "sortable-table", ".bi-grip-vertical", "sortable-ghost", _selfReference);

            _projects = LogEntryRepository.GetProjects()
                .Select(g => new Project { Guid = g, Name = g.ToString() })
                .Prepend(new Project { Guid = null, Name = "All" })
                .ToList();

            await RefreshAsync();
        }
    }

    public void Dispose() => _selfReference?.Dispose();

    [JSInvokable]
    public void OnMoveItem(int oldIndex, int newIndex)
    {
        var item = _logProperties[oldIndex];
        _logProperties.RemoveAt(oldIndex);
        _logProperties.Insert(newIndex, item);

        // ToDo: Change log table as well

        StateHasChanged();
    }

    private string? GetValue(LogEntryDto log, string column)
    {
        return column switch
        {
            "Timestamp" => log.Timestamp.ToString(new CultureInfo("de-DE")),
            "Level" => log.Level,
            "Message" => log.Message,
            _ => log.Properties.TryGetValue(column, out var v) ? v?.ToString() : null
        };
    }

    private void SyncProperties()
    {
        var discovered = new HashSet<string>
        {
            "Timestamp", "Level", "Message"
        };

        foreach (var log in _logEntries)
        {
            foreach (var key in log.Properties.Keys)
                discovered.Add(key);
        }

        var map = _logProperties.ToDictionary(p => p.Name);

        _logProperties = discovered
            .Select(name =>
                map.TryGetValue(name, out var existing)
                    ? existing
                    : new LogProperties { Name = name, IsActive = name is "Timestamp" or "Level" or "Message" })
            .Where(p => discovered.Contains(p.Name))
            .ToList();
    }

    private async Task RefreshAsync()
    {
        _logEntries = LogEntryRepository.Get(_selectedProject, null, _filter).ToList();
        SyncProperties();
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnProjectChanged(ChangeEventArgs e)
    {
        _selectedProject = Guid.TryParse(e.Value?.ToString(), out var g) ? g : null;
        await RefreshAsync();
    }

    private async Task OnFilterChanged(ChangeEventArgs e)
    {
        _filter = e.Value?.ToString();
        await RefreshAsync();
    }

    private void OnPropertyChanged()
    {
        StateHasChanged();
    }
}
